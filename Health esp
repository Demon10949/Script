local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local function createHealthBar(character)
    -- Ожидаем загрузку компонентов
    local humanoid = character:WaitForChild("Humanoid")
    local head = character:WaitForChild("Head")

    -- Создаём видимый GUI
    local healthGui = Instance.new("BillboardGui")
    healthGui.Name = "HealthBar"
    healthGui.Size = UDim2.new(5, 0, 0.7, 0)  -- Увеличил размер для заметности
    healthGui.StudsOffset = Vector3.new(0, 2.5, 0)
    healthGui.AlwaysOnTop = true
    healthGui.Adornee = head
    healthGui.Active = true  -- Критически важный параметр
    healthGui.Enabled = true
    healthGui.LightInfluence = 0  -- Делаем видимым в тени
    healthGui.Parent = character

    -- Фоновая подложка (должна быть хорошо видна)
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.fromRGB(25, 25, 25)  -- Тёмный фон
    background.BackgroundTransparency = 0.2
    background.BorderSizePixel = 2
    background.BorderColor3 = Color3.fromRGB(100, 100, 100)
    background.Parent = healthGui

    -- Основная полоска здоровья (яркая и контрастная)
    local healthBar = Instance.new("Frame")
    healthBar.Name = "HealthBar"
    healthBar.AnchorPoint = Vector2.new(0, 0.5)
    healthBar.Position = UDim2.new(0, 0, 0.5, 0)
    healthBar.Size = UDim2.new(1, 0, 0.8, 0)
    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBar.BorderSizePixel = 0
    healthBar.ZIndex = 2
    healthBar.Parent = background

    -- Текст здоровья (для наглядности)
    local healthText = Instance.new("TextLabel")
    healthText.Name = "HealthText"
    healthText.Size = UDim2.new(1, 0, 1, 0)
    healthText.BackgroundTransparency = 1
    healthText.Text = math.floor(humanoid.Health).."/"..math.floor(humanoid.MaxHealth)
    healthText.TextColor3 = Color3.new(1, 1, 1)
    healthText.Font = Enum.Font.SourceSansBold
    healthText.TextSize = 18
    healthText.ZIndex = 3
    healthText.Parent = healthGui

    -- Функция плавного обновления
    local function updateHealth()
        local healthPercent = humanoid.Health / humanoid.MaxHealth
        
        -- Плавное изменение через Tween
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Linear)
        local tween = TweenService:Create(
            healthBar,
            tweenInfo,
            {Size = UDim2.new(healthPercent, 0, 0.8, 0)}
        )
        tween:Play()

        -- Изменение цвета
        if healthPercent > 0.6 then
            healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        elseif healthPercent > 0.3 then
            healthBar.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
        else
            healthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        end

        -- Обновление текста
        healthText.Text = math.floor(humanoid.Health).."/"..math.floor(humanoid.MaxHealth)
    end

    -- Подключаем обработчики
    humanoid.HealthChanged:Connect(updateHealth)
    humanoid.Died:Connect(function()
        healthGui:Destroy()
    end)
    
    -- Первоначальное обновление
    updateHealth()
end

-- Обработка игроков
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(createHealthBar)
    if player.Character then
        createHealthBar(player.Character)
    end
end)

-- Обработка уже подключенных игроков
for _, player in ipairs(Players:GetPlayers()) do
    if player.Character then
        createHealthBar(player.Character)
    end
end
